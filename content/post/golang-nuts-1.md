+++
date = "2015-09-29T00:07:31+09:00"
description = "Go1.5のbuildmode=c-sharedと格闘中"
title = "c-sharedでruntime error"

+++

Goでプラグイン機構を実現したいと思い調べていたら、[@hnakamur2](https://twitter.com/hnakamur2)さんに1.5から追加されたシェアードライブラリがいいと思うと教えて頂いた。  
その時一緒に教えて頂いた[cookieo9/goffi](https://github.com/cookieo9/goffi)のREADMEに、こっちも開発活発だよと示された[binet/go-ffi](https://bitbucket.org/binet/go-ffi)を試してみた。(後に前者も試してみたが結果は変わらずだった。)

ところが、実際に試してみると、buildmode=c-sharedでコンパイルしたパッケージをgo-ffiで読み込んで実際にエクスポートされた関数を実行する際に以下のエラーが発生。

```
~/src/test❯ go run main.go
runtime/cgo: could not obtain pthread_keys
	tried 0x101 0x102 0x103 0x104 0x105 0x106 0x107 0x108 0x109 0x10a 0x10b 0x10c 0x10d 0x10e 0x10f 0x110 0x111 0x112 0x113 0x115 0x116 0x117 0x118 0x119 0x11a 0x11b 0x11c 0x11d 0x11e 0x11f 0x120 0x121 0x122 0x123 0x124 0x125 0x126 0x127 0x128 0x129 0x12a 0x12b 0x12c 0x12d 0x12e 0x12f 0x130 0x131 0x132 0x133 0x134 0x135 0x136 0x137 0x138 0x139 0x13a 0x13b 0x13c 0x13d 0x13e 0x13f 0x140 0x141 0x142 0x143 0x144 0x145 0x146 0x147 0x148 0x149 0x14a 0x14b 0x14c 0x14d 0x14e 0x14f 0x150 0x151 0x152 0x153 0x154 0x155 0x156 0x157 0x158 0x159 0x15a 0x15b 0x15c 0x15d 0x15e 0x15f 0x160 0x161 0x162 0x163 0x164 0x165 0x166 0x167 0x168 0x169 0x16a 0x16b 0x16c 0x16d 0x16e 0x16f 0x170 0x171 0x172 0x173 0x174 0x175 0x176 0x177 0x178 0x179 0x17a 0x17b 0x17c 0x17d 0x17e 0x17f 0x180 0x181
signal: abort trap
```

以下に完全なコードがある。  
[`runtime/cgo: could not obtain pthread_keys' on darwin/amd64](https://gist.github.com/hatajoe/4fd972ff1545418867b6)

vagrant上のCentOS6.5では正常に動作したので、どうもdarwin/amd64環境でbuildmode=c-sharedでコンパイルしたdylibを読み込めないっぽい。(ちなみにpythonからは正常に読み込む事ができたし、libm.dylibも正常に読み込めた。)  
エラーは `go/src/runtime/cgo/gcc_darwin_amd64.c` で出力されているが、こいつが何なのかよくわからずハードコードされた謎の `#define magic1 (0x23581321345589ULL)` が怪しいに違いない！とか勝手に色々考えていたけど不毛なのでgolang-nutsで聞いてみることにした。(ちなみにこれも@hnakamur2さんに勧めて頂いたのであった。)

英語の文章を(真面目に)書いたのは初めてで結構戸惑った。まぁいくら考えても出来んもんは出来んので取り敢えず書いて出してみた。  
なかなか反映されないなーと不安ながらに見ていたら、初回投稿反映に24時間程かかるみたいなことが書いてあった。  
以下、全文。

>
How can I do to fix `runtime/cgo: could not obtain pthread_keys' on darwin/amd64
>
Hello.
>
Everyone, I got error when I tried to load package using https://bitbucket.org/binet/go-ffi.  
Package is compiled with buildmode=c-shared on darwin/amd64 machine.  
Do you have any idea what I can do to fix this?
>
Here is the error:
>
runtime/cgo: could not obtain pthread_keys  
	tried 0x101 0x102 0x103 0x104 0x105 0x106 0x107 0x108 0x109 0x10a 0x10b 0x10c 0x10d 0x10e 0x10f 0x110 0x111 0x112 0x113 0x115 0x116 0x117 0x118 0x119 0x11a 0x11b 0x11c 0x11d 0x11e 0x11f 0x120 0x121 0x122 0x123 0x124 0x125 0x126 0x127 0x128 0x129 0x12a 0x12b 0x12c 0x12d 0x12e 0x12f 0x130 0x131 0x132 0x133 0x134 0x135 0x136 0x137 0x138 0x139 0x13a 0x13b 0x13c 0x13d 0x13e 0x13f 0x140 0x141 0x142 0x143 0x144 0x145 0x146 0x147 0x148 0x149 0x14a 0x14b 0x14c 0x14d 0x14e 0x14f 0x150 0x151 0x152 0x153 0x154 0x155 0x156 0x157 0x158 0x159 0x15a 0x15b 0x15c 0x15d 0x15e 0x15f 0x160 0x161 0x162 0x163 0x164 0x165 0x166 0x167 0x168 0x169 0x16a 0x16b 0x16c 0x16d 0x16e 0x16f 0x170 0x171 0x172 0x173 0x174 0x175 0x176 0x177 0x178 0x179 0x17a 0x17b 0x17c 0x17d 0x17e 0x17f 0x180 0x181  
signal: abort trap
>
Complete code is here. https://gist.github.com/hatajoe/4fd972ff1545418867b6  
Thank you.
>
Hatajoe

また動きがあり次第お伝えします。(変な英語になってないかやっぱ気になるもんだな・・。)
